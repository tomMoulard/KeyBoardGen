<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyboardGen - Genetic Algorithm Keyboard Layout Optimizer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .header-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .header-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
        }

        .header-links a:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
            position: relative;
            cursor: help;
        }

        .form-group label[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 400;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            margin-bottom: 5px;
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .form-group label[title]:hover::before {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 15px;
            border: 5px solid transparent;
            border-top-color: #2d3748;
            z-index: 1000;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-group input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 60px;
            text-align: center;
            background: #f7fafc;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
            color: #667eea;
        }

        .input-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .input-tab {
            flex: 1;
            padding: 10px 15px;
            background: #f7fafc;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s ease;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .input-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .input-tab:hover:not(.active) {
            background: #edf2f7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .url-input-group input {
            flex: 1;
        }

        .btn-fetch {
            padding: 12px 20px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-fetch:hover:not(:disabled) {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .btn-fetch:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .fetch-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }

        .fetch-status.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .fetch-status.error {
            background: #fed7d7;
            color: #c53030;
            border-left: 4px solid #f56565;
        }

        .fetch-status.loading {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-section {
            grid-column: 1 / -1;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .progress-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .progress-item .label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 5px;
        }

        .progress-item .value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }

        .keyboard-layout {
            background: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .keyboard-row {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .key {
            min-width: 40px;
            height: 40px;
            background: #4a5568;
            border: 2px solid #718096;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .key.optimized {
            background: #667eea;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .fitness-chart {
            height: 300px;
            background: #f7fafc;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f56565;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #48bb78;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .process-output {
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
        }

        .process-output summary {
            padding: 15px;
            cursor: pointer;
            background: #edf2f7;
            border-radius: 8px 8px 0 0;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
        }

        .process-output summary:hover {
            background: #e2e8f0;
        }

        .process-output[open] summary {
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .process-output summary small {
            margin-left: auto;
            color: #718096;
            font-style: italic;
        }

        .output-content {
            padding: 15px;
        }

        .output-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0 0 15px 0;
            border: 1px solid #4a5568;
        }

        .output-log:empty::before {
            content: "No output yet. Start optimization to see process details...";
            color: #a0aec0;
            font-style: italic;
        }

        .output-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .output-icon {
            font-size: 1.1em;
        }

        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
        }

        .log-entry.info {
            color: #63b3ed;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.warning {
            color: #fbb965;
        }

        .log-entry.error {
            color: #f56565;
        }

        .log-timestamp {
            color: #a0aec0;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header-links {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .header-links a {
                min-width: 140px;
                text-align: center;
            }

            .input-tabs {
                flex-direction: column;
            }

            .input-tab {
                border-radius: 0;
                border-bottom: 1px solid #e2e8f0;
            }

            .input-tab:first-child {
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }

            .input-tab:last-child {
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
                border-bottom: none;
            }

            .url-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .url-input-group input {
                margin-bottom: 10px;
            }

            .container {
                padding: 10px;
            }

            .output-controls {
                flex-direction: column;
            }

            .process-output summary small {
                display: none;
            }
        }

        /* Dark Theme Support */
        @media (prefers-color-scheme: dark) {
            body {
                color: #e2e8f0;
                background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            }

            .card {
                background: #2d3748;
                color: #e2e8f0;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }

            .card h2 {
                color: #e2e8f0;
                border-bottom: 2px solid #4a5568;
            }

            .form-group label {
                color: #e2e8f0;
            }

            .form-group label[title]:hover::after {
                background: #1a202c;
                color: #e2e8f0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .form-group label[title]:hover::before {
                border-top-color: #1a202c;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                background: #1a202c;
                color: #e2e8f0;
                border: 2px solid #4a5568;
            }

            .form-group input::placeholder,
            .form-group textarea::placeholder {
                color: #a0aec0;
            }

            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            }

            .range-value {
                background: #1a202c;
                color: #667eea;
            }

            .input-tab {
                background: #1a202c;
                color: #a0aec0;
            }

            .input-tab.active {
                background: #2d3748;
                color: #667eea;
                border-bottom: 2px solid #667eea;
            }

            .input-tab:hover:not(.active) {
                background: #4a5568;
            }

            .btn-secondary {
                background: #4a5568;
                color: #e2e8f0;
            }

            .btn-secondary:hover:not(:disabled) {
                background: #718096;
            }

            .fetch-status.success {
                background: #22543d;
                color: #c6f6d5;
                border-left: 4px solid #48bb78;
            }

            .fetch-status.error {
                background: #742a2a;
                color: #fed7d7;
                border-left: 4px solid #f56565;
            }

            .fetch-status.loading {
                background: #2c5282;
                color: #bee3f8;
                border-left: 4px solid #4299e1;
            }

            .progress-bar {
                background: #1a202c;
            }

            .progress-item {
                background: #1a202c;
                color: #e2e8f0;
            }

            .progress-item .label {
                color: #a0aec0;
            }

            .progress-item .value {
                color: #e2e8f0;
            }

            .fitness-chart {
                background: #1a202c;
            }

            .error-message {
                background: #742a2a;
                color: #fed7d7;
                border-left: 4px solid #f56565;
            }

            .success-message {
                background: #22543d;
                color: #c6f6d5;
                border-left: 4px solid #48bb78;
            }

            .stat-card {
                background: #1a202c;
                color: #e2e8f0;
            }

            .stat-card .stat-label {
                color: #a0aec0;
            }

            .process-output {
                border: 1px solid #4a5568;
                background: #1a202c;
            }

            .process-output summary {
                background: #2d3748;
                color: #e2e8f0;
            }

            .process-output summary:hover {
                background: #4a5568;
            }

            .process-output[open] summary {
                border-bottom: 1px solid #4a5568;
            }

            .process-output summary small {
                color: #a0aec0;
            }

            .output-log {
                background: #1a202c;
                color: #e2e8f0;
                border: 1px solid #2d3748;
            }

            .output-log:empty::before {
                color: #718096;
            }

            .log-entry.info {
                color: #90cdf4;
            }

            .log-entry.success {
                color: #9ae6b4;
            }

            .log-entry.warning {
                color: #fbd38d;
            }

            .log-entry.error {
                color: #fc8181;
            }

            .log-timestamp {
                color: #718096;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎹 KeyboardGen</h1>
            <p>Genetic Algorithm Keyboard Layout Optimizer</p>
            <div class="header-links">
                <a href="https://github.com/tomMoulard/KeyBoardGen" target="_blank" rel="noopener noreferrer">
                    📂 Repository
                </a>
                <a href="https://tom.moulard.org" target="_blank" rel="noopener noreferrer">
                    👨‍💻 Author
                </a>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>⚙️ Configuration</h2>
                <form id="configForm">
                    <div class="form-group">
                        <label>Input Text (for analysis):</label>
                        <div class="input-tabs">
                            <button type="button" class="input-tab active" data-tab="manual">✍️ Manual Input</button>
                            <button type="button" class="input-tab" data-tab="datasets">📚 Pre-imported Datasets</button>
                            <button type="button" class="input-tab" data-tab="url">🌐 Fetch from URL</button>
                        </div>

                        <div id="manual-content" class="tab-content active">
                            <textarea id="inputText" placeholder="Enter your typing sample here... (e.g., your coding style, writing sample, etc.)"></textarea>
                            <small style="color: #718096;">Provide a representative sample of your typing patterns for optimal layout generation.</small>
                        </div>

                        <div id="datasets-content" class="tab-content">
                            <select id="datasetSelect">
                                <option value="">Select a pre-imported dataset...</option>
                                <option value="harrypotter">Harry Potter (Complete Series)</option>
                                <option value="shakespeare">Shakespeare (Complete Works)</option>
                                <option value="lorem">Lorem Ipsum</option>
                                <option value="code-python">Python Code Sample</option>
                                <option value="code-javascript">JavaScript Code Sample</option>
                            </select>
                            <small style="color: #718096;">Choose from popular text datasets for keyboard optimization.</small>
                        </div>

                        <div id="url-content" class="tab-content">
                            <div class="url-input-group">
                                <div style="flex: 1;">
                                    <input type="url" id="urlInput" placeholder="https://dgoldberg.sdsu.edu/515/harrypotter.txt" />
                                </div>
                                <button type="button" class="btn-fetch" id="fetchBtn">📥 Fetch</button>
                            </div>
                            <div id="fetchStatus" class="fetch-status"></div>
                            <small style="color: #718096;">Fetch text content from any URL (supports plain text, HTML, and common document formats). Try the Harry Potter URL above!</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="populationSize" title="Number of keyboard layouts in each generation. Larger populations explore more solutions but take longer to compute. Recommended: 50-200.">Population Size:</label>
                            <input type="number" id="populationSize" min="10" max="1000" value="100">
                        </div>
                        <div class="form-group">
                            <label for="maxGeneration" title="Maximum number of evolution cycles. More generations allow for better optimization but take longer. The algorithm may stop early if convergence is reached.">Max Generations:</label>
                            <input type="number" id="maxGeneration" min="0" max="10000" value="1000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="mutationRate" title="Probability of random changes in keyboard layouts. Higher values increase exploration but may slow convergence. Typical range: 0.05-0.2.">Mutation Rate:</label>
                            <div class="range-group">
                                <input type="range" id="mutationRate" min="0" max="1" step="0.01" value="0.1">
                                <span class="range-value" id="mutationRateValue">0.10</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="crossoverRate" title="Probability of combining two parent layouts to create offspring. Higher values promote information sharing between good solutions. Typical range: 0.6-0.9.">Crossover Rate:</label>
                            <div class="range-group">
                                <input type="range" id="crossoverRate" min="0" max="1" step="0.01" value="0.8">
                                <span class="range-value" id="crossoverRateValue">0.80</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="elitismCount" title="Number of best layouts automatically preserved in each generation. Ensures good solutions aren't lost during evolution. Recommended: 2-10% of population size.">Elitism Count:</label>
                            <input type="number" id="elitismCount" min="0" max="50" value="5">
                        </div>
                        <div class="form-group">
                            <label for="convergenceStops" title="Stop optimization early if no improvement is seen for this many generations. Saves time when the algorithm has converged. 0 = disabled, typical values: 50-200.">Convergence Stops:</label>
                            <input type="number" id="convergenceStops" min="0" max="1000" value="0">
                            <small style="color: #718096;">0 = disabled</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showProgress" checked>
                            <label for="showProgress" title="Display real-time progress updates including generation count, fitness scores, and time estimates during optimization.">Show Progress Updates</label>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" id="optimizeBtn">
                            🚀 Start Optimization
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>📊 Current Status</h2>
                <div id="statusContent">
                    <p style="color: #718096; text-align: center; padding: 40px;">
                        Configure your parameters and start optimization to see progress here.
                    </p>
                </div>

                <div class="loading hidden" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Loading WASM module...</p>
                </div>

                <div class="loading hidden" id="optimizingIndicator">
                    <div class="spinner"></div>
                    <p>Optimization in progress...</p>
                </div>

                <details class="process-output hidden" id="processOutput">
                    <summary>
                        <span class="output-icon">📋</span>
                        <strong>Process Output</strong>
                        <small>(Click to expand/collapse)</small>
                    </summary>
                    <div class="output-content">
                        <pre id="outputLog" class="output-log"></pre>
                        <div class="output-controls">
                            <button type="button" class="btn btn-secondary btn-small" id="clearLogBtn">Clear Log</button>
                            <button type="button" class="btn btn-secondary btn-small" id="copyLogBtn">Copy Log</button>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <div class="card results-section hidden" id="resultsSection">
            <h2>🎯 Optimization Results</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script src="wasm_exec.js"></script>
    <script>
        class KeyboardOptimizer {
            constructor() {
                this.wasmReady = false;
                this.optimizing = false;
                this.config = null;
                this.parameterInfo = null;
                this.currentInputMethod = 'manual';
                this.datasets = {
                    'harrypotter': `https://api.allorigins.win/get?url=${encodeURIComponent('https://dgoldberg.sdsu.edu/515/harrypotter.txt')}`,
                    'shakespeare': `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.gutenberg.org/files/100/100-0.txt')}`,
                    'lorem': 'data:text/plain;base64,' + btoa('Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.'),
                    'code-python': 'data:text/plain;base64,' + btoa(`def fibonacci(n):
    """Generate Fibonacci sequence up to n terms."""
    if n <= 0:
        return []
    elif n == 1:
        return [0]
    elif n == 2:
        return [0, 1]

    sequence = [0, 1]
    for i in range(2, n):
        sequence.append(sequence[i-1] + sequence[i-2])

    return sequence

class Calculator:
    def __init__(self):
        self.history = []

    def add(self, a, b):
        result = a + b
        self.history.append(f"{a} + {b} = {result}")
        return result

    def multiply(self, a, b):
        result = a * b
        self.history.append(f"{a} * {b} = {result}")
        return result

if __name__ == "__main__":
    calc = Calculator()
    print(calc.add(5, 3))
    print(calc.multiply(4, 7))
    print(fibonacci(10))`),
                    'code-javascript': 'index.html'
                };
                this.initializeElements();
                this.loadWasm();
            }

            initializeElements() {
                this.form = document.getElementById('configForm');
                this.optimizeBtn = document.getElementById('optimizeBtn');
                this.statusContent = document.getElementById('statusContent');
                this.resultsSection = document.getElementById('resultsSection');
                this.resultsContent = document.getElementById('resultsContent');
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.optimizingIndicator = document.getElementById('optimizingIndicator');
                this.processOutput = document.getElementById('processOutput');
                this.outputLog = document.getElementById('outputLog');
                this.clearLogBtn = document.getElementById('clearLogBtn');
                this.copyLogBtn = document.getElementById('copyLogBtn');

                // Input method elements
                this.inputText = document.getElementById('inputText');
                this.datasetSelect = document.getElementById('datasetSelect');
                this.urlInput = document.getElementById('urlInput');
                this.fetchBtn = document.getElementById('fetchBtn');
                this.fetchStatus = document.getElementById('fetchStatus');

                // Bind events
                this.form.addEventListener('submit', (e) => this.startOptimization(e));
                this.clearLogBtn.addEventListener('click', () => this.clearLog());
                this.copyLogBtn.addEventListener('click', () => this.copyLog());

                // Input method events
                document.querySelectorAll('.input-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchInputTab(tab.dataset.tab));
                });

                this.datasetSelect.addEventListener('change', () => this.loadDataset());
                this.fetchBtn.addEventListener('click', () => this.fetchFromUrl());
                this.urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.fetchFromUrl();
                    }
                });

                // Range input handlers
                document.getElementById('mutationRate').addEventListener('input', (e) => {
                    document.getElementById('mutationRateValue').textContent = parseFloat(e.target.value).toFixed(2);
                });

                document.getElementById('crossoverRate').addEventListener('input', (e) => {
                    document.getElementById('crossoverRateValue').textContent = parseFloat(e.target.value).toFixed(2);
                });
            }

            async loadWasm() {
                this.loadingIndicator.classList.remove('hidden');

                try {
                    const go = new Go();
                    const result = await WebAssembly.instantiateStreaming(fetch("keyboardgen.wasm"), go.importObject);
                    go.run(result.instance);

                    // Wait for WASM functions to be available
                    await this.waitForWasmFunctions();

                    this.wasmReady = true;
                    this.loadDefaultConfig();
                    this.updateButtonStates();
                    this.loadingIndicator.classList.add('hidden');
                    this.updateStatus("✅ WASM module loaded successfully. Ready to optimize!");
                    this.addLogEntry("WASM module loaded successfully", "success");
                } catch (error) {
                    console.error('Failed to load WASM:', error);
                    this.loadingIndicator.classList.add('hidden');
                    this.updateStatus(`❌ Failed to load WASM module: ${error.message}`, 'error');
                    this.addLogEntry(`Failed to load WASM module: ${error.message}`, "error");
                }
            }

            async waitForWasmFunctions() {
                return new Promise((resolve) => {
                    const checkFunctions = () => {
                        if (window.getDefaultConfig && window.validateConfig && window.optimizeKeyboard) {
                            resolve();
                        } else {
                            setTimeout(checkFunctions, 100);
                        }
                    };
                    checkFunctions();
                });
            }

            loadDefaultConfig() {
                try {
                    const defaultConfigJson = window.getDefaultConfig();
                    this.config = JSON.parse(defaultConfigJson);

                    // Load parameter info
                    const paramInfoJson = window.getParameterInfo();
                    this.parameterInfo = JSON.parse(paramInfoJson);

                    this.populateForm();
                } catch (error) {
                    console.error('Failed to load default config:', error);
                    this.updateStatus(`❌ Failed to load default configuration: ${error.message}`, 'error');
                }
            }

            populateForm() {
                // Populate form fields with default values
                if (this.config) {
                    document.getElementById('populationSize').value = this.config.population_size;
                    document.getElementById('maxGeneration').value = this.config.max_generation;
                    document.getElementById('mutationRate').value = this.config.mutation_rate;
                    document.getElementById('mutationRateValue').textContent = this.config.mutation_rate.toFixed(2);
                    document.getElementById('crossoverRate').value = this.config.crossover_rate;
                    document.getElementById('crossoverRateValue').textContent = this.config.crossover_rate.toFixed(2);
                    document.getElementById('elitismCount').value = this.config.elitism_count;
                    document.getElementById('convergenceStops').value = this.config.convergence_stops;
                    document.getElementById('showProgress').checked = this.config.show_progress;
                }
            }

            getFormConfig() {
                return {
                    input_text: this.getInputText(),
                    population_size: parseInt(document.getElementById('populationSize').value),
                    max_generation: parseInt(document.getElementById('maxGeneration').value),
                    mutation_rate: parseFloat(document.getElementById('mutationRate').value),
                    crossover_rate: parseFloat(document.getElementById('crossoverRate').value),
                    elitism_count: parseInt(document.getElementById('elitismCount').value),
                    convergence_stops: parseInt(document.getElementById('convergenceStops').value),
                    convergence_tolerance: 0.000001,
                    worker_count: 1,
                    verbose: false,
                    show_progress: document.getElementById('showProgress').checked,
                    save_interval: 50
                };
            }

            getInputText() {
                // Return the text from the currently active input method
                const manualText = this.inputText.value.trim();
                if (manualText) {
                    return manualText;
                }

                // If manual input is empty, check if we have text from other methods
                if (this.currentInputMethod === 'datasets' || this.currentInputMethod === 'url') {
                    return this.inputText.value; // This would have been populated by loadDataset or fetchFromUrl
                }

                return manualText;
            }

            switchInputTab(tabName) {
                // Update active tab
                document.querySelectorAll('.input-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-content`).classList.add('active');

                this.currentInputMethod = tabName;
                this.hideFetchStatus();
            }

            async loadDataset() {
                const selectedDataset = this.datasetSelect.value;
                if (!selectedDataset) {
                    this.inputText.value = '';
                    return;
                }

                this.showFetchStatus('Loading dataset...', 'loading');

                try {
                    const url = this.datasets[selectedDataset];
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    let text;
                    if (url.includes('allorigins.win')) {
                        const data = await response.json();
                        text = data.contents;
                    } else {
                        text = await response.text();
                    }

                    // For large datasets, limit to reasonable size (first 50000 characters)
                    if (text.length > 50000) {
                        text = text.substring(0, 50000);
                        this.showFetchStatus(`Dataset loaded successfully (truncated to 50,000 characters for performance)`, 'success');
                    } else {
                        this.showFetchStatus(`Dataset loaded successfully (${text.length} characters)`, 'success');
                    }

                    this.inputText.value = text;
                    this.addLogEntry(`Loaded dataset: ${selectedDataset} (${text.length} characters)`, "success");

                } catch (error) {
                    console.error('Error loading dataset:', error);
                    this.showFetchStatus(`Failed to load dataset: ${error.message}`, 'error');
                    this.addLogEntry(`Failed to load dataset ${selectedDataset}: ${error.message}`, "error");
                }
            }

            async fetchFromUrl() {
                const url = this.urlInput.value.trim();
                if (!url) {
                    this.showFetchStatus('Please enter a URL', 'error');
                    return;
                }

                this.fetchBtn.disabled = true;
                this.showFetchStatus('Fetching content...', 'loading');

                try {
                    // Use a CORS proxy for external URLs if needed
                    let fetchUrl = url;

                    // If URL doesn't start with data: or blob:, and we're not on the same origin,
                    // we might need to handle CORS
                    if (!url.startsWith('data:') && !url.startsWith('blob:')) {
                        try {
                            // Try direct fetch first
                            const testResponse = await fetch(url, { method: 'HEAD' });
                        } catch (corsError) {
                            // If CORS fails, try with a simple CORS proxy
                            fetchUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                        }
                    }

                    const response = await fetch(fetchUrl);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    let text;
                    if (fetchUrl.includes('allorigins.win')) {
                        const data = await response.json();
                        text = data.contents;
                    } else {
                        text = await response.text();
                    }

                    // Clean up HTML if it looks like HTML content
                    if (text.includes('<html') || text.includes('<!DOCTYPE')) {
                        // Basic HTML cleanup - extract text content
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = text;

                        // Remove script and style elements
                        const scripts = tempDiv.querySelectorAll('script, style');
                        scripts.forEach(el => el.remove());

                        text = tempDiv.textContent || tempDiv.innerText || '';
                    }

                    // Limit size for performance
                    if (text.length > 50000) {
                        text = text.substring(0, 50000);
                        this.showFetchStatus(`Content fetched successfully (truncated to 50,000 characters for performance)`, 'success');
                    } else {
                        this.showFetchStatus(`Content fetched successfully (${text.length} characters)`, 'success');
                    }

                    this.inputText.value = text;
                    this.addLogEntry(`Fetched content from URL: ${url} (${text.length} characters)`, "success");

                } catch (error) {
                    console.error('Error fetching URL:', error);
                    this.showFetchStatus(`Failed to fetch content: ${error.message}`, 'error');
                    this.addLogEntry(`Failed to fetch URL ${url}: ${error.message}`, "error");
                } finally {
                    this.fetchBtn.disabled = false;
                }
            }

            showFetchStatus(message, type) {
                this.fetchStatus.textContent = message;
                this.fetchStatus.className = `fetch-status ${type}`;
                this.fetchStatus.style.display = 'block';
            }

            hideFetchStatus() {
                this.fetchStatus.style.display = 'none';
            }

            validateForm() {
                const inputText = this.getInputText();

                // Check if we have input text
                if (!inputText || inputText.trim().length === 0) {
                    this.updateStatus('❌ Please provide input text using one of the available methods: manual input, dataset selection, or URL fetching.', 'error');
                    return false;
                }

                // Check minimum text length
                if (inputText.trim().length < 10) {
                    this.updateStatus('❌ Input text is too short. Please provide at least 10 characters for meaningful analysis.', 'error');
                    return false;
                }

                const config = this.getFormConfig();

                // Validate with WASM if available
                if (window.validateConfig) {
                    const validation = window.validateConfig(JSON.stringify(config));
                    if (!validation.valid) {
                        this.updateStatus(`❌ Configuration error: ${validation.error}`, 'error');
                        return false;
                    }
                }

                return true;
            }

            startOptimization(e) {
                e.preventDefault();

                if (!this.wasmReady) {
                    this.updateStatus('❌ WASM module not ready yet. Please wait...', 'error');
                    return;
                }

                if (!this.validateForm()) {
                    return;
                }

                this.optimizing = true;
                this.updateButtonStates();

                const config = this.getFormConfig();

                // Show spinner and hide status content initially
                this.statusContent.classList.add('hidden');
                this.optimizingIndicator.classList.remove('hidden');

                this.addLogEntry("Starting keyboard layout optimization", "info");
                this.addLogEntry(`Configuration: Population=${config.population_size}, Generations=${config.max_generation}, Mutation=${config.mutation_rate}, Crossover=${config.crossover_rate}`, "info");

                // Ensure process output is visible when optimization starts
                this.processOutput.classList.remove('hidden');
                this.processOutput.open = true;

                // Set up callback for progress updates
                window.keyboardOptimizationCallback = (type, data) => {
                    if (type === 'progress') {
                        this.handleProgress(JSON.parse(data));
                    } else if (type === 'result') {
                        this.handleResult(JSON.parse(data));
                    }
                };

                this.resultsSection.classList.add('hidden');

                try {
                    const result = window.optimizeKeyboard(JSON.stringify(config), window.keyboardOptimizationCallback);
                    console.log('Optimization started:', result);
                    this.addLogEntry(`Genetic algorithm initialized: ${result}`, "success");

                    // Set a timeout to check if progress is being made
                    this.progressTimeout = setTimeout(() => {
                        if (this.optimizing) {
                            this.addLogEntry("Waiting for optimization progress... This may take a moment for large populations.", "info");
                        }
                    }, 5000);
                } catch (error) {
                    console.error('Optimization error:', error);

                    // Hide spinner and show status on error
                    this.optimizingIndicator.classList.add('hidden');
                    this.statusContent.classList.remove('hidden');

                    this.updateStatus(`❌ Optimization failed: ${error.message}`, 'error');
                    this.addLogEntry(`Optimization initialization failed: ${error.message}`, "error");
                    this.optimizing = false;
                    this.updateButtonStates();
                }
            }


            handleProgress(progress) {
                // Clear progress timeout once we start receiving updates
                if (this.progressTimeout) {
                    clearTimeout(this.progressTimeout);
                    this.progressTimeout = null;
                }

                // Hide spinner and show progress on first progress update
                this.optimizingIndicator.classList.add('hidden');
                this.statusContent.classList.remove('hidden');

                const statusHtml = `
                    <div class="progress-info">
                        <div class="progress-item">
                            <div class="label">Generation</div>
                            <div class="value">${progress.generation}</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Best Fitness</div>
                            <div class="value">${progress.best_fitness.toFixed(6)}</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Fitness Change</div>
                            <div class="value">${progress.fitness_change ? progress.fitness_change.toFixed(6) : '0.000000'}</div>
                        </div>
                        <div class="progress-item">
                            <div class="label">Elapsed Time</div>
                            <div class="value">${progress.elapsed_time}</div>
                        </div>
                        ${progress.eta ? `
                        <div class="progress-item">
                            <div class="label">ETA</div>
                            <div class="value">${progress.eta}</div>
                        </div>
                        ` : ''}
                    </div>
                `;

                this.statusContent.innerHTML = statusHtml;

                // Add detailed log entry for progress milestones
                if (progress.generation === 1 || progress.generation % 25 === 0 || (progress.fitness_change && Math.abs(progress.fitness_change) > 0.0001)) {
                    const logMessage = `Generation ${progress.generation}: fitness=${progress.best_fitness.toFixed(6)}${progress.fitness_change ? `, change=${progress.fitness_change > 0 ? '+' : ''}${progress.fitness_change.toFixed(6)}` : ''}${progress.eta ? `, ETA=${progress.eta}` : ''}`;
                    this.addLogEntry(logMessage, progress.fitness_change > 0 ? "success" : "info");
                }

                // Add a "heartbeat" log every 100 generations to show the process is still active
                if (progress.generation > 0 && progress.generation % 100 === 0) {
                    this.addLogEntry(`Optimization active: ${progress.generation} generations completed, elapsed: ${progress.elapsed_time}`, "info");
                }
            }

            handleResult(result) {
                // Clear progress timeout if it exists
                if (this.progressTimeout) {
                    clearTimeout(this.progressTimeout);
                    this.progressTimeout = null;
                }

                this.optimizing = false;
                this.updateButtonStates();

                // Hide spinner and show status
                this.optimizingIndicator.classList.add('hidden');
                this.statusContent.classList.remove('hidden');

                if (!result.success) {
                    this.updateStatus(`❌ Optimization failed: ${result.error}`, 'error');
                    this.addLogEntry(`Optimization failed: ${result.error}`, "error");
                    return;
                }

                this.updateStatus('✅ Optimization completed successfully!', 'success');
                this.addLogEntry(`Optimization completed successfully in ${result.total_time}`, "success");
                this.addLogEntry(`Final fitness: ${result.best_fitness.toFixed(6)}`, "success");
                this.addLogEntry(`Optimized layout: ${result.layout}`, "info");

                if (result.statistics && result.statistics.improvement_percentage) {
                    this.addLogEntry(`Performance improvement: ${result.statistics.improvement_percentage.toFixed(2)}%`, "success");
                }

                this.displayResults(result);
            }

            displayResults(result) {
                const statistics = result.statistics;
                const improvement = statistics.improvement_percentage ? statistics.improvement_percentage.toFixed(2) : 'N/A';

                const resultsHtml = `
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <div class="stat-value">${result.best_fitness.toFixed(6)}</div>
                            <div class="stat-label">Best Fitness</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${statistics.generation_count}</div>
                            <div class="stat-label">Generations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${result.total_time}</div>
                            <div class="stat-label">Total Time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${improvement}%</div>
                            <div class="stat-label">Improvement</div>
                        </div>
                    </div>

                    <h3>🎹 Optimized Layout</h3>
                    <div class="keyboard-layout">
                        <div style="color: white; text-align: center; margin-bottom: 15px;">
                            Layout String: <code style="background: rgba(255,255,255,0.1); padding: 5px; border-radius: 3px;">${result.layout}</code>
                        </div>
                        ${this.renderKeyboardLayout(result.layout)}
                    </div>

                    <h3>📈 Fitness Evolution</h3>
                    <div class="fitness-chart">
                        <canvas class="chart-canvas" id="fitnessChart"></canvas>
                    </div>

                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; padding: 10px; background: #f7fafc; border-radius: 5px;">
                            <strong>🔍 Detailed Results (JSON)</strong>
                        </summary>
                        <pre style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
                    </details>
                `;

                this.resultsContent.innerHTML = resultsHtml;
                this.resultsSection.classList.remove('hidden');

                // Draw fitness chart
                this.drawFitnessChart(result.fitness_history);

                // Scroll to results
                this.resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            renderKeyboardLayout(layout) {
                // Standard QWERTY key positions for visual representation
                const keyboardRows = [
                    { keys: '`1234567890-=', start: 0 },
                    { keys: 'qwertyuiop[]\\', start: 13 },
                    { keys: 'asdfghjkl;\'', start: 26 },
                    { keys: 'zxcvbnm,./', start: 37 }
                ];

                let html = '';
                let layoutIndex = 0;

                keyboardRows.forEach(row => {
                    html += '<div class="keyboard-row">';

                    for (let i = 0; i < row.keys.length && layoutIndex < layout.length; i++) {
                        const optimizedChar = layout[layoutIndex] || '';
                        const originalChar = row.keys[i];
                        const isOptimized = optimizedChar !== originalChar;

                        html += `<div class="key ${isOptimized ? 'optimized' : ''}" title="Original: ${originalChar} → Optimized: ${optimizedChar}">
                            ${this.escapeHtml(optimizedChar)}
                        </div>`;
                        layoutIndex++;
                    }

                    html += '</div>';
                });

                return html;
            }

            drawFitnessChart(fitnessHistory) {
                const canvas = document.getElementById('fitnessChart');
                if (!canvas || !fitnessHistory || fitnessHistory.length === 0) return;

                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * window.devicePixelRatio;
                canvas.height = rect.height * window.devicePixelRatio;
                ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

                const width = rect.width;
                const height = rect.height;
                const padding = 40;

                // Clear canvas
                ctx.fillStyle = '#f7fafc';
                ctx.fillRect(0, 0, width, height);

                if (fitnessHistory.length < 2) return;

                // Find min/max values
                const minFitness = Math.min(...fitnessHistory);
                const maxFitness = Math.max(...fitnessHistory);
                const fitnessRange = maxFitness - minFitness;

                // Draw axes
                ctx.strokeStyle = '#4a5568';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();

                // Draw fitness line
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();

                for (let i = 0; i < fitnessHistory.length; i++) {
                    const x = padding + (i / (fitnessHistory.length - 1)) * (width - 2 * padding);
                    const y = height - padding - ((fitnessHistory[i] - minFitness) / fitnessRange) * (height - 2 * padding);

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                // Add labels
                ctx.fillStyle = '#4a5568';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Generation', width / 2, height - 5);

                ctx.save();
                ctx.translate(15, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Fitness', 0, 0);
                ctx.restore();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStatus(message, type = 'info') {
                const className = type === 'error' ? 'error-message' :
                                type === 'success' ? 'success-message' : '';

                this.statusContent.innerHTML = `<div class="${className}">${message}</div>`;
            }

            updateButtonStates() {
                this.optimizeBtn.disabled = this.optimizing || !this.wasmReady;
            }

            addLogEntry(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;

                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${this.escapeHtml(message)}`;

                this.outputLog.appendChild(logEntry);
                this.outputLog.scrollTop = this.outputLog.scrollHeight;

                // Show the process output section if it's hidden
                if (this.processOutput.classList.contains('hidden')) {
                    this.processOutput.classList.remove('hidden');
                }
            }

            clearLog() {
                this.outputLog.innerHTML = '';
                this.addLogEntry('Log cleared by user', 'info');
            }

            async copyLog() {
                try {
                    const logText = this.outputLog.textContent;
                    await navigator.clipboard.writeText(logText);
                    this.addLogEntry('Log copied to clipboard', 'success');
                } catch (error) {
                    console.error('Failed to copy log:', error);
                    this.addLogEntry('Failed to copy log to clipboard', 'error');
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new KeyboardOptimizer();
        });
    </script>
</body>
</html>